var fs = require('fs');

function init() {
   var $ = global.$;
   var path = require('path');
   var conf = JSON.parse(fs.readFileSync('.tmp.conf'));
   /*var conf = {
      'win-height'         : 600,
      'win-width'          : 800,
      'index-file'         : 'file://' + __dirname + '/index.html',
      'inspect'            : true,
      'server-js-api'      : 'updater', //generated js api from server script
      'server-path'        : __dirname + '/../ui.py'
   };*/

   var api = require(conf['server-js-api']);
   var server_path = path.resolve(conf['server-path']);

   function on_init_app() {
      /*if ( global.user == null )
         $(window).trigger('active-page', 'page-create-account');
      else
         $(window).trigger('active-page', 'page-login');*/
   }

	$(global.window.document).ready(function() {
      // stdio transport for communicating with server
      var server = new api(server_path, ['service', '-s', '--path', '/tmp/pycloak-ui']); //this is the api wrapper
      global.server = server; // making it available to everything

      console.log(server);
      // Catch all error when rpc call errors occur
      server.on('error', function(error) {
         console.log('UNHANDLED CALL ERROR', error);
      });

      // Once api is connected we start here
      server.on('connected', function() {
         server.get_api_version()
            .result(function(data) {
               console.log('server api version: ', data);
            })
            .error(function(error) {
               console.log('error!', error);
            });

         /*server.list_accounts()
            .result(function(data) {
               if (data.length > 0) {
                  global.user = data[0];
                  $('#login-user').text(global.user);
                  server.start_session(global.user, '')
                     .result(function(data) {
                        global.session = data;
                        on_init_app();
                     })
                     .error(function(error) {
                        console.log(error);
                     });
               } else {
                  global.user = 'default';
                  server.create_account(global.user)
                     .result(function(data) {
                        server.start_session(global.user, '')
                           .result(function(data) {
                              global.session = data;
                              on_init_app();
                           })
                           .error(function(error) {
                              console.log(error);
                           });
                     })
                     .error(function(error) {
                        console.log(error)
                     });
               }

            })
            .error(function(error) {
               // TODO: Handle api call error
               console.log(error);
            });*/

      });

      server.start();

	});
}

module.exports.init = init;
